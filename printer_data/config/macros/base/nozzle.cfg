[gcode_macro CLEAN_NOZZLE]
description: Clean nozzle using configurable temperature and wipe patterns
gcode:
    SAVE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE

    # Get cleaning temperature - use EXTRUDER param if available, otherwise default to 200
    {% set NOZZLE_TEMP = params.EXTRUDER|default(params.TEMP|default(150))|int %}
    {% set wipes = params.WIPES|default(5)|int %}

    # Homes the printer, sets absolute positioning, and updates the Stealthburner LEDs.
    STATUS_HOMING
    # Check homing status and home if needed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        RESPOND TYPE=COMMAND MSG="XYZ Homing"
        SET_DISPLAY_TEXT MSG="XYZ Homing"
        G28                             # Full home if not already homed
    {% elif 'z' not in printer.toolhead.homed_axes %}
        RESPOND TYPE=COMMAND MSG="Z Homing"
        SET_DISPLAY_TEXT MSG="Z Homing"
        G28 Z                           # Home Z if only Z is unhomed
    {% endif %}

    # Now proceed with nozzle cleaning sequence
    G91                                        # Relative positioning
    G1 Z10 F300                                # Raise nozzle for safety (when clean is done in a print)
    
    G90                                        # Absolute positioning
    RESPOND TYPE=COMMAND MSG="Move to cleaning position with safe Z height"
    G1 X-7.5 Y10 F9000                         # Move to cleaning position with safe Z height (-7.5, 10)
    G1 Z10 F300                                # Lower Nozzle to 10mm (Absolute positioning)
    G4 P100                                    # Pause 100ms?
    M400                                       # Wait for moves

    STATUS_HEATING
    RESPOND TYPE=COMMAND MSG="Heating nozzle to {NOZZLE_TEMP}Â°C"
    SET_DISPLAY_TEXT MSG="Heating nozzle"
    M109 S{NOZZLE_TEMP}                        # Heat and wait
    M106 S127                                  # Fan at 50%

    STATUS_CLEANING
    RESPOND TYPE=COMMAND MSG="Cleaning nozzle"
    SET_DISPLAY_TEXT MSG="Cleaning nozzle"

    # Combined cleaning pattern
    G1 Z-2 F900                                # Lower Nozzle to -2mm

    G1 Y45 F2400
    G1 X-8.2 Y10
    G1 Y45 
    G1 X-8.2 Y10
    G1 Y38
    G1 X-9.2 Y12
    G1 Y38
    G1 X-9.2 Y12
    G1 Y33 
    G1 X-8.2 Y14
    G1 Y33 
    G1 X-8.2 Y14
    G1 Y28
    G1 X-9.2 Y16
    G1 Y28
    G1 X-9.2 Y16
    G1 Z5
   
    M400                                       # Wait for moves to complete
    RESPOND TYPE=COMMAND MSG="Clean Complete"
    SET_DISPLAY_TEXT MSG="Clean Complete"
    M107                                       # Turn off fan

    # Return to safe position
    G91                                        # Relative positioning
    G1 Z10 F300                                # Raise nozzle
    G90                                        # Absolute positioning
    G28 Z                                      # Home Z

    STATUS_READY
    # Only turn off heaters if we're not in a print
    {% if printer.idle_timeout.state == "Idle" %}
        TURN_OFF_HEATERS
        RESPOND TYPE=COMMAND MSG="Cleaning complete - heaters turned off (idle state)"
   {% else %}
        RESPOND TYPE=COMMAND MSG="Cleaning complete - heaters maintained (printing state)"
    {% endif %}

    RESTORE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE