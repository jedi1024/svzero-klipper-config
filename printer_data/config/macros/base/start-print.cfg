# https://github.com/ss1gohan13/A-better-print_start-macro-SV08

[gcode_macro PRINT_START]
gcode:
    START_PRINT { rawparams }

[gcode_macro START_PRINT]
gcode:
    # This part fetches data from your slicer, such as bed temp, extruder temp, chamber temp, and the size of your printer.
    {% set target_bed = params.BED|int %}
    {% set target_extruder = params.EXTRUDER|int %}
    {% set raw_material = params.FILAMENT|default("PLA")|string|upper %}
    {% set target_chamber = params.CHAMBER|default("45")|int %}
    {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
    {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}
    {% set current_bed = printer.heater_bed.temperature|int %}
    {% set skew_profile = printer["gcode_macro _USER_VARIABLES"].skew_profile %}
    {% set chamber_sensor_name = printer["gcode_macro _USER_VARIABLES"].chamber_sensor_name %}

    RESPOND TYPE=COMMAND MSG="Filament Detected: {raw_material}, Chamber: {target_chamber}"

    # Homes the printer, sets absolute positioning, and updates the Stealthburner LEDs.
    STATUS_HOMING
    # Check homing status and home if needed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                                                      # Full home if not already homed
    {% elif 'z' not in printer.toolhead.homed_axes %}
        G28 Z                                                    # Home Z if only Z is unhomed
    {% endif %}

    G90                                                          # Use absolute/relative coordinates
    M400                                                         # Wait for current moves to finish
    CLEAR_PAUSE                                                  # Clear any existing pause state

    # Uncomment for bed mesh (1 of 2)
    BED_MESH_CLEAR                                               # Clears old saved bed mesh (if any)

    # Checks if the bed temp is higher than 90C - if so, then trigger a heat soak.
    {% if params.BED|int > 90 %}
        # Display bed temperature
        SET_DISPLAY_TEXT MSG="Bed: {target_bed}C"

        # Sets SB-LEDs to heating-mode
        STATUS_HEATING
        
        # Turns on the PT-fan
        M106 S255
        # Conditional check for nevermore pin
        {% if printer["output_pin nevermore"] is defined %}
            # Turns on the Nevermore
            SET_PIN PIN=nevermore VALUE=1
        {% endif %}
        # Go to the center of the bed
        G1 X{x_wait} Y{y_wait} Z15 F9000
        # Sets the target temp for the bed
        M190 S{target_bed}

        # Start chamber heating progress monitoring
        # Conditional check for chamber thermistor
        {% if printer[chamber_sensor_name] is defined %}
            RESPOND TYPE=COMMAND MSG="Chamber temperature sensor is available: {chamber_sensor_name}"

            # Waits for the chamber to reach the desired temp
            # Display chamber monitoring status
            RESPOND TYPE=COMMAND MSG="Waiting chamber: {target_chamber}C"
            SET_DISPLAY_TEXT MSG="Waiting chamber: {target_chamber}C"

            M191 S{target_chamber}

            # TEMPERATURE_WAIT SENSOR="{chamber_sensor_name}" MINIMUM={target_chamber}
        {% else %}
            RESPOND TYPE=COMMAND MSG="Chamber temperature sensor is unavailable."

            # Waits for 15mins by default when chamber temperature sensor is not available
            {% set dynamic_soak_time = 15 %}

            {% if current_bed >= target_bed %}
                RESPOND TYPE=COMMAND MSG="Bed is hotter than target {target_bed}C"
                {% set dynamic_soak_time = 3%}
            {% else %}
                {% set deviation = (target_bed - current_bed) / target_bed %}
                {% if deviation >= 0.30  %}
                    RESPOND TYPE=COMMAND MSG="Bed was {current_bed}C, < 70% of target {target_bed}C"
                    {% set dynamic_soak_time = dynamic_soak_time * 1 %}
                {% elif deviation >= 0.2 %}
                    RESPOND TYPE=COMMAND MSG="Bed was {current_bed}C, 70% ~ 80% of target {target_bed}C"
                    {% set dynamic_soak_time = dynamic_soak_time * 0.75%}
                {% elif deviation >= 0.1 %}
                    RESPOND TYPE=COMMAND MSG="Bed was {current_bed}C, 80% ~ 90% of target {target_bed}C"
                    {% set dynamic_soak_time = dynamic_soak_time * 0.5%}
                {% else%}
                    RESPOND TYPE=COMMAND MSG="Bed was {current_bed}C, 90% or higher of target {target_bed}C"
                    {% set dynamic_soak_time = 3%}
                {% endif%}
            {% endif%}
            RESPOND TYPE=COMMAND MSG="Heat soak for {dynamic_soak_time} mins"
            _HEAT_WAIT MINUTES={dynamic_soak_time}
        {% endif %}
    {% else %}
        # If the bed temp is not over 90c, then handle soak based on material
        # Display bed temperature
        SET_DISPLAY_TEXT MSG="Bed: {target_bed}C"
        # Sets SB-leds to heating-mode
        STATUS_HEATING
        # Go to center of the bed
        G1 X{x_wait} Y{y_wait} Z15 F9000
        # Sets the target temp for the bed
        M190 S{target_bed}

        # Material-based soak times with variant handling
        SET_DISPLAY_TEXT MSG=""

        # Extract base material type by handling variants
        {% set material = namespace(type="") %}
        {% if "PLA" in raw_material %}
            {% set material.type = "PLA" %}
        {% elif "PETG" in raw_material %}
            {% set material.type = "PETG" %}
        {% elif "TPU" in raw_material or "TPE" in raw_material %}
            {% set material.type = "TPU" %}
        {% elif "PVA" in raw_material %}
            {% set material.type = "PVA" %}
        {% elif "HIPS" in raw_material %}
            {% set material.type = "HIPS" %}
        {% else %}
            {% set material.type = raw_material %}
        {% endif %}

        # Define soak times
        {% set soak_time = {
            "PLA": 3,    # 3 minutes - Standard PLA soak time
            "PETG": 4,   # 4 minutes - PETG needs slightly longer to stabilize
            "TPU": 3,    # 3 minutes - TPU/TPE materials
            "PVA": 3,    # 3 minutes - Support material, similar to PLA
            "HIPS": 4    # 4 minutes - When used as support/primary under 90C
        }[material.type]|default(5) %}                      # Default to 5 minutes if material not found

        # Display soak time and material
        SET_DISPLAY_TEXT MSG="Soak: {soak_time}min ({raw_material})"
        # Execute soak timer
        _HEAT_WAIT MINUTES={soak_time}
    {% endif %}


    # Conditional check to ensure Z is homed after leveling procedures
    {% if 'z' not in printer.toolhead.homed_axes %}
        # Sets SB-LEDs to homing-mode
        STATUS_HOMING
        # Display Z homing status
        SET_DISPLAY_TEXT MSG="Z homing"
        # Home Z if needed after leveling
        G28 Z
    {% endif %}

    # Heating the nozzle to 150C. This helps with getting a correct Z-home
    # Sets SB-LEDs to heating-mode
    STATUS_HEATING
    # Display hotend temperature
    SET_DISPLAY_TEXT MSG="Hotend: 150C"
    # Heats the nozzle to 150C
    M109 S150

    SET_DISPLAY_TEXT MSG="Cleaning the nozzle..."
    # Sets SB-LEDs to cleaning-mode
    STATUS_CLEANING
    # Clean nozzle before printing
    CLEAN_NOZZLE #EXTRUDER={target_extruder}

    # Display wait message
    SET_DISPLAY_TEXT MSG="Nozzle cooling 150C..."
    # Heats the nozzle to 150C
    M109 S150

    # Display wait message
    SET_DISPLAY_TEXT MSG="Hang tight..."
    # Wait 30s to stabilize
    G4 S30

    # Sets SB-LEDs to z-calibration-mode
    STATUS_CALIBRATING_Z
    # Display tappy tap message
    SET_DISPLAY_TEXT MSG="Tappy Tap..."
    # run Eddy-NG Tap, See: https://hackmd.io/yEF4CEntSHiFTj230CdD0Q
    PROBE_EDDY_NG_TAP

    # KAMP Smart Park the toolhead near the beginning of the print
    SMART_PARK

    {% if skew_profile is defined %}
        RESPOND TYPE=COMMAND MSG="Loading Skew Profile: {skew_profile}"
        SKEW_PROFILE LOAD=calilantern_skew_profile
        RESPOND TYPE=COMMAND MSG="Skew Profile: {skew_profile} is loaded"
    {% endif %}

    # Uncomment for bed mesh (2 of 2)
    # Sets SB-LEDs to bed mesh-mode
    STATUS_MESHING
    # Display bed mesh status
    SET_DISPLAY_TEXT MSG="Bed mesh"
    # Starts bed mesh  Uncomment Method=rapid_scan for eddy rapid bed meshing
    # BED_MESH_CALIBRATE ADAPTIVE=1 Method=rapid_scan
    EDDYNG_BED_MESH_EXPERIMENTAL

    # Wait for current moves to finish
    M400

    # KAMP smart park
    SMART_PARK

    # Heats up the nozzle to target via data from the slicer
    # Display target hotend temperature
    SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}C"
    # Sets SB-LEDs to heating-mode
    STATUS_HEATING
    # Turns off part cooling fan
    M107
    # Heats the nozzle to printing temp
    M109 S{target_extruder}

    # Gets ready to print by doing a purge line and updating the SB-LEDs
    # Display purge status
    SET_DISPLAY_TEXT MSG="Purge Nozzle"
    # Sets SB-LEDs to cleaning-mode
    STATUS_CLEANING
    # KAMP line purge
    LINE_PURGE

    # Display print starting
    SET_DISPLAY_TEXT MSG="Printer goes brrr"
    # Sets SB-LEDs to printing-mode
    STATUS_PRINTING